version: "1.0.0"
spec_version: "3.2.0"
date: "2025-11-12"
title: "Binance Futures Availability Database - Implementation Plan"

x-adr-links:
  - id: "0001"
    title: "Schema design: daily table pattern"
    path: "docs/decisions/0001-schema-design-daily-table.md"
  - id: "0002"
    title: "Storage technology: DuckDB"
    path: "docs/decisions/0002-storage-technology-duckdb.md"
  - id: "0003"
    title: "Error handling: strict raise policy"
    path: "docs/decisions/0003-error-handling-strict-policy.md"
  - id: "0004"
    title: "Automation: APScheduler (superseded by ADR-0009)"
    path: "docs/decisions/0004-automation-apscheduler.md"
    status: "superseded"

objective: |
  Build standalone DuckDB database tracking daily availability of all USDT
  perpetual futures from Binance Vision (~327 active, dynamically discovered).
  Date range: 2019-09-25 to present, with automated daily updates via GitHub Actions.

slos:
  availability:
    metric: "Database update success rate"
    target: "95% of daily updates complete successfully"
    measurement: "Monitor scheduler logs for successful probe completions"
    
  correctness:
    metric: "Data accuracy vs Binance exchangeInfo API"
    target: ">95% match for current date snapshot"
    measurement: "Daily validation cross-check with exchangeInfo endpoint"
    
  observability:
    metric: "Error visibility and debugging capability"
    target: "All failures logged with full context (symbol, date, HTTP status, error message)"
    measurement: "Structured logs with timestamp, level, component, error details"
    
  maintainability:
    metric: "Code testability and documentation completeness"
    target: "80%+ test coverage, all public functions documented"
    measurement: "pytest --cov, docstring coverage check"

architecture:
  storage:
    technology: "DuckDB 1.0+"
    location: "~/.cache/binance-futures/availability.duckdb"
    schema_ref: "../schema/availability-database.schema.json"
    estimated_size: "50-150 MB (compressed columnar)"
    growth_rate: "~25 MB/year (~327 rows/day × ~200 bytes/row compressed)"

  data_source:
    name: "Binance Vision S3"
    method: "HTTP HEAD requests (daily) / AWS CLI (backfill)"
    url_pattern: "https://data.binance.vision/data/futures/um/daily/klines/{symbol}/1m/{symbol}-1m-{YYYY-MM-DD}.zip"
    authentication: "None (public bucket)"
    note: "Hybrid strategy per ADR-0005"

  error_handling:
    policy: "Raise and propagate all errors immediately"
    rationale: "ADR-0003: Strict error policy enables fail-fast, explicit visibility"
    no_retries: true
    no_fallbacks: true
    no_silent_failures: true

  automation:
    scheduler: "GitHub Actions (superseded APScheduler per ADR-0009)"
    frequency: "Daily at 3:00 AM UTC"
    persistence: "GitHub workflow state"
    distribution: "GitHub Releases (automated)"
    update_target: "Yesterday's data (S3 Vision T+1 availability)"

implementation_phases:
  phase_1_core_infrastructure:
    duration: "2 days"
    status: "completed"
    completed_date: "2025-11-12"
    deliverables:
      - "DuckDB schema creation (database/schema.py)"
      - "Core database operations (database/availability_db.py)"
      - "Basic insert/query methods with UPSERT"
    validation:
      - "Schema creates successfully with indexes"
      - "Insert 1000 test rows, verify <5ms single-date query"
      - "Upsert idempotency (insert same data twice, verify single row)"
    validation_results:
      - "All unit tests passing (21/21)"
      - "DuckDB schema with 3 indexes operational"
      - "UPSERT idempotency verified in test_upsert_replaces_existing"

  phase_2_probing_layer:
    duration: "1 day"
    status: "completed"
    completed_date: "2025-11-12"
    deliverables:
      - "S3 Vision HTTP HEAD probing (probing/s3_vision.py)"
      - "Symbol discovery (probing/symbol_discovery.py)"
      - "Batch parallel probing (probing/batch_prober.py)"
    validation:
      - "Successfully probe BTCUSDT for 2024-01-15"
      - "Handle 404 gracefully (unavailable symbol)"
      - "Raise on network errors (strict error policy)"
    validation_results:
      - "test_check_symbol_availability_success passing"
      - "test_check_symbol_availability_404 passing"
      - "test_check_symbol_availability_network_error passing"

  phase_3_query_layer:
    duration: "1 day"
    status: "completed"
    completed_date: "2025-11-12"
    deliverables:
      - "Snapshot queries (queries/snapshots.py)"
      - "Timeline queries (queries/timelines.py)"
      - "Analytics queries (queries/analytics.py)"
    validation:
      - "Snapshot query returns available symbols for date"
      - "Timeline query returns symbol history"
      - "Date range queries handle string input"
    validation_results:
      - "All snapshot query tests passing (5/5)"
      - "String date input parsing working"
      - "Context manager pattern verified"

  phase_4_validation_layer:
    duration: "1 day"
    status: "completed"
    completed_date: "2025-11-12"
    deliverables:
      - "Date continuity checks (validation/continuity.py)"
      - "Completeness checks (validation/completeness.py)"
      - "Cross-check with exchangeInfo API (validation/cross_check.py)"
    validation:
      - "Detect missing dates in sequence"
      - "Verify no gaps exist in continuous data"
      - "Validate date range completeness"
    validation_results:
      - "test_check_continuity_no_gaps passing"
      - "test_check_continuity_with_gap passing"
      - "test_validate_continuity passing"

  phase_5_scheduler_automation:
    duration: "1 day"
    status: "completed"
    completed_date: "2025-11-12"
    deliverables:
      - "Daily update job (scheduler/daily_update.py)"
      - "Historical backfill (scheduler/backfill.py)"
      - "Structured logging (scheduler/notifications.py)"
    validation:
      - "Backfill script executable"
      - "Scheduler daemon can start"
      - "Logging configuration loads"
    validation_results:
      - "Scripts created and executable"
      - "APScheduler configuration implemented"
      - "Checkpoint-based backfill logic ready"

  phase_6_cli_interface:
    duration: "1 day"
    status: "completed"
    completed_date: "2025-11-12"
    deliverables:
      - "CLI entry point (cli/main.py)"
      - "Query commands (cli/query.py)"
      - "Update commands (cli/update.py)"
    validation:
      - "CLI entry point registered in pyproject.toml"
      - "Command structure defined"
      - "Help text available"
    validation_results:
      - "binance-futures-availability entry point configured"
      - "All CLI modules implemented"
      - "Argparse structure complete"

  phase_7_testing:
    duration: "2 days"
    status: "completed"
    completed_date: "2025-11-12"
    deliverables:
      - "Test fixtures (tests/conftest.py)"
      - "Unit tests (tests/test_*)"
      - "Integration test markers"
    validation:
      - "21 unit tests passing"
      - "Fixtures providing temp_db, populated_db"
      - "Mock S3 responses working"
    validation_results:
      - "21/21 unit tests passing"
      - "Core coverage: database (77-100%), probing (87%), queries (100%)"
      - "Integration tests marked and deselectable"

  phase_8_documentation:
    duration: "1 day"
    status: "completed"
    completed_date: "2025-11-12"
    deliverables:
      - "All 4 MADRs (docs/decisions/)"
      - "JSON Schemas (docs/schema/)"
      - "User guides (docs/guides/)"
      - "Operations docs (docs/operations/)"
    validation:
      - "ADR-0001 through ADR-0004 complete"
      - "QUICKSTART.md readable"
      - "TROUBLESHOOTING.md useful"
    validation_results:
      - "4 MADRs documented and committed"
      - "2 JSON Schema files created"
      - "6 documentation files completed"

  phase_9_historical_backfill:
    duration: "4-6 hours"
    status: "completed"
    completed_date: "2025-11-14"
    actual_time: "~25 min (AWS CLI method per ADR-0005)"
    deliverables:
      - "Backfill 2019-09-25 to yesterday (2240 days × ~327 symbols)"
      - "Database size 50-150 MB"
      - "No missing dates"
    validation:
      - "Database exists and published to GitHub Releases"
      - "Continuity check passes (no gaps)"
      - "Symbol count 100-400 for recent dates (dynamic discovery)"
    note: "Significantly faster than estimated due to AWS CLI optimization"

  phase_10_validation:
    duration: "30 minutes"
    status: "completed"
    completed_date: "2025-11-15"
    deliverables:
      - "Run all validation checks"
      - "HTTP 451 geo-blocking handled gracefully"
      - "Verify SLOs met"
    validation:
      - "Continuity: No missing dates"
      - "Completeness: Symbol counts valid (dynamic)"
      - "Correctness: Validation integrated into GitHub Actions workflow"
    note: "Validation integrated into GitHub Actions workflow (ADR-0009)"

  phase_11_automation:
    duration: "1 hour"
    status: "superseded"
    superseded_by: "ADR-0009 (GitHub Actions automation)"
    superseded_date: "2025-11-15"
    deliverables:
      - "GitHub Actions workflow deployed"
      - "Daily updates automated (3AM UTC)"
      - "GitHub Releases distribution configured"
    note: "APScheduler approach replaced with GitHub Actions"

dependencies:
  required:
    - name: "duckdb"
      version: ">=1.0.0"
      purpose: "Columnar database engine"
    - name: "urllib3"
      version: ">=2.0.0"
      purpose: "HTTP client for S3 HEAD requests"
    - name: "awscli"
      version: ">=2.0.0"
      purpose: "S3 bulk operations (AWS CLI per ADR-0005)"
      
  development:
    - name: "pytest"
      version: ">=8.0.0"
      purpose: "Testing framework"
    - name: "pytest-cov"
      version: ">=5.0.0"
      purpose: "Coverage reporting (enforce 80%+ target)"
    - name: "pytest-mock"
      version: ">=3.14.0"
      purpose: "Mocking for unit tests"
    - name: "ruff"
      version: ">=0.4.0"
      purpose: "Linting and formatting"

success_criteria:
  functional:
    - "Database contains complete data (2019-09-25 to yesterday)"
    - "No missing dates (continuity validation passes)"
    - ">95% match with Binance exchangeInfo API"
    - "All 10 MADRs documented with approved status"

  performance:
    - "Snapshot query <1ms (~327 symbols for single date)"
    - "Timeline query <10ms (2240 days for single symbol)"
    - "Date range query <100ms (90 days × ~327 symbols)"
    - "Daily update <2 minutes (~327 probes)"
    
  reliability:
    - "Automated updates for 7 consecutive days without manual intervention"
    - "Error logging captures all failures with context"
    - "Validation checks pass after each update"
    
  maintainability:
    - "80%+ test coverage (unit + integration)"
    - "All public functions documented (docstrings)"
    - "All 10 MADRs committed and linked in commits"
    - "README explains setup in <10 steps"
