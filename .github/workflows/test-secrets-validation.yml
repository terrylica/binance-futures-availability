name: Test Doppler-Synced Secrets

on:
  workflow_dispatch:

jobs:
  validate-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Validate all secrets exist
        env:
          PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          GH_TOKEN_TERRYLICA: ${{ secrets.GH_TOKEN_TERRYLICA }}
          GH_TOKEN_EONLABS_PAT: ${{ secrets.GH_TOKEN_EONLABS_PAT }}
          GH_TOKEN_SEMANTIC_RELEASE: ${{ secrets.GH_TOKEN_SEMANTIC_RELEASE }}
        run: |
          echo "=== Validating Doppler-Synced Secrets ==="

          # Check each secret is non-empty
          declare -A secrets=(
            ["PUSHOVER_APP_TOKEN"]="${PUSHOVER_APP_TOKEN}"
            ["PUSHOVER_USER_KEY"]="${PUSHOVER_USER_KEY}"
            ["GH_TOKEN_TERRYLICA"]="${GH_TOKEN_TERRYLICA}"
            ["GH_TOKEN_EONLABS_PAT"]="${GH_TOKEN_EONLABS_PAT}"
            ["GH_TOKEN_SEMANTIC_RELEASE"]="${GH_TOKEN_SEMANTIC_RELEASE}"
          )

          failed=0
          for secret_name in "${!secrets[@]}"; do
            secret_value="${secrets[$secret_name]}"
            if [ -z "$secret_value" ]; then
              echo "❌ FAIL: $secret_name is empty or not set"
              failed=$((failed + 1))
            else
              length=${#secret_value}
              echo "✅ PASS: $secret_name exists (length: $length)"
            fi
          done

          if [ $failed -gt 0 ]; then
            echo ""
            echo "❌ Validation failed: $failed secret(s) missing"
            exit 1
          fi

          echo ""
          echo "✅ All 5 secrets validated successfully"

      - name: Test Pushover API authentication
        env:
          PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
        run: |
          echo "=== Testing Pushover API Authentication ==="

          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -F "token=${PUSHOVER_APP_TOKEN}" \
            -F "user=${PUSHOVER_USER_KEY}" \
            -F "message=GitHub Actions secrets validation test" \
            https://api.pushover.net/1/messages.json)

          if [ "$response" = "200" ]; then
            echo "✅ Pushover API authentication successful"
          else
            echo "❌ Pushover API authentication failed (HTTP $response)"
            exit 1
          fi

      - name: Test GitHub token authentication
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_TERRYLICA }}
        run: |
          echo "=== Testing GitHub Token Authentication ==="

          # Test token with gh CLI
          user=$(gh api user --jq '.login')

          if [ -n "$user" ]; then
            echo "✅ GitHub token authenticated as: $user"
          else
            echo "❌ GitHub token authentication failed"
            exit 1
          fi

      - name: Summary report
        if: always()
        run: |
          echo "=== Validation Summary ==="
          echo "✅ Secret existence: Validated"
          echo "✅ Pushover API: Tested"
          echo "✅ GitHub token: Tested"
          echo ""
          echo "Sync timestamp: 2025-11-25T08:04:49Z"
          echo "Source: Doppler (notifications/prd)"
