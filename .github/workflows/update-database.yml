name: Update Binance Futures Availability Database

# Run daily at 3:00 AM UTC (1 hour after S3 Vision data becomes available at 2:00 AM)
# Also allow manual triggering for gap-filling or testing
on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3:00 AM UTC
  workflow_dispatch:
    inputs:
      update_mode:
        description: 'Update mode: daily (yesterday only) or backfill (custom range)'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - backfill
      start_date:
        description: 'Backfill start date (YYYY-MM-DD) - only used if mode=backfill'
        required: false
        type: string
      end_date:
        description: 'Backfill end date (YYYY-MM-DD) - only used if mode=backfill'
        required: false
        type: string

permissions:
  contents: write  # For creating releases and pushing database
  pull-requests: write  # For creating PR comments (optional notifications)

jobs:
  update-database:
    runs-on: ubuntu-latest

    env:
      DB_PATH: ${{ github.workspace }}/.cache/binance-futures/availability.duckdb
      PYTHON_VERSION: '3.12'

    steps:
      # ============================================================================
      # SETUP: Environment and Dependencies
      # ============================================================================

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Install uv (Python package manager)
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Verify AWS CLI (for bulk operations)
        run: aws --version

      - name: Install project dependencies
        run: |
          uv pip install --system -e ".[dev]"

      # ============================================================================
      # RESTORE: Download existing database from latest release
      # ============================================================================

      - name: Download existing database
        id: download_db
        run: |
          # Create cache directory
          mkdir -p $(dirname "$DB_PATH")

          # Try to download latest release asset
          gh release download latest \
            --pattern "availability.duckdb" \
            --output "$DB_PATH" \
            --clobber \
            2>/dev/null || echo "No existing database found, starting fresh"

          # Check if database exists and show info
          if [ -f "$DB_PATH" ]; then
            echo "Database found: $(ls -lh "$DB_PATH" | awk '{print $5}')"
            echo "db_exists=true" >> $GITHUB_OUTPUT

            # Query database stats
            uv run python .github/scripts/check_database_stats.py
          else
            echo "No existing database, will create new one"
            echo "db_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================================
      # UPDATE: Run daily update or backfill based on trigger
      # ============================================================================

      - name: Run daily update (scheduled or manual daily mode)
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.update_mode == 'daily')
        run: |
          echo "Running daily update for yesterday's data..."

          # Run update for yesterday
          uv run python .github/scripts/run_daily_update.py

      - name: Run backfill (manual backfill mode)
        if: github.event_name == 'workflow_dispatch' && inputs.update_mode == 'backfill'
        run: |
          echo "Running backfill mode..."

          START_DATE="${{ inputs.start_date }}"
          END_DATE="${{ inputs.end_date }}"

          # Build command with optional date arguments
          CMD="uv run python scripts/operations/backfill.py"
          [ -n "$START_DATE" ] && CMD="$CMD --start-date $START_DATE"
          [ -n "$END_DATE" ] && CMD="$CMD --end-date $END_DATE"

          echo "Executing: $CMD"
          $CMD

      # ============================================================================
      # VALIDATE: Run all validation checks
      # ============================================================================

      - name: Run validation checks
        id: validate
        if: steps.download_db.outputs.db_exists == 'true'
        run: |
          echo "Running database validation..."
          uv run python scripts/operations/validate.py --verbose

          # Capture validation results
          if [ $? -eq 0 ]; then
            echo "validation_passed=true" >> $GITHUB_OUTPUT
            echo "✅ All validation checks passed"
          else
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            echo "❌ Validation checks failed"
            exit 1
          fi

      - name: Generate database statistics
        id: stats
        if: steps.download_db.outputs.db_exists == 'true'
        run: |
          echo "Generating database statistics..."

          # Query comprehensive stats
          uv run python .github/scripts/generate_stats.py

          # Read stats for GitHub output
          LATEST_DATE=$(cat stats.json | jq -r '.latest_date')
          TOTAL_RECORDS=$(cat stats.json | jq -r '.total_records')
          AVAILABILITY_PCT=$(cat stats.json | jq -r '.availability_pct')

          echo "latest_date=$LATEST_DATE" >> $GITHUB_OUTPUT
          echo "total_records=$TOTAL_RECORDS" >> $GITHUB_OUTPUT
          echo "availability_pct=$AVAILABILITY_PCT" >> $GITHUB_OUTPUT

      # ============================================================================
      # TEST: Run pytest to ensure code quality
      # ============================================================================

      - name: Run tests (excluding integration tests)
        run: |
          echo "Running unit tests..."
          uv run pytest -m "not integration" --cov-report=term

      # ============================================================================
      # PUBLISH: Create release and upload database
      # ============================================================================

      - name: Compress database for distribution
        run: |
          echo "Compressing database..."
          cd $(dirname "$DB_PATH")
          gzip -c availability.duckdb > availability.duckdb.gz
          ls -lh availability.duckdb*

      - name: Generate release notes
        id: release_notes
        env:
          LATEST_DATE: ${{ steps.stats.outputs.latest_date }}
          TOTAL_RECORDS: ${{ steps.stats.outputs.total_records }}
          AVAILABILITY_PCT: ${{ steps.stats.outputs.availability_pct }}
          TRIGGER: ${{ github.event_name }}
          UPDATE_MODE: ${{ github.event_name == 'schedule' && 'daily' || inputs.update_mode }}
          VALIDATION_STATUS: ${{ steps.validate.outputs.validation_passed == 'true' && 'Passed' || 'Failed' }}
          REPO: ${{ github.repository }}
        run: |
          cat > release_notes.md << EOF
          ## Database Update - $(date -u +"%Y-%m-%d %H:%M UTC")

          ### Statistics
          - **Latest Date**: $LATEST_DATE
          - **Total Records**: $TOTAL_RECORDS
          - **Availability**: $AVAILABILITY_PCT%

          ### Update Details
          - **Trigger**: $TRIGGER
          - **Mode**: $UPDATE_MODE
          - **Validation**: $VALIDATION_STATUS

          ### Files
          - \`availability.duckdb\` - Uncompressed database (50-150 MB)
          - \`availability.duckdb.gz\` - Compressed database (recommended for download)

          ### Usage
          \`\`\`bash
          # Download and extract
          wget https://github.com/$REPO/releases/download/latest/availability.duckdb.gz
          gunzip availability.duckdb.gz

          # Query with Python
          import duckdb
          conn = duckdb.connect('availability.duckdb', read_only=True)
          result = conn.execute('SELECT * FROM daily_availability LIMIT 10').fetchall()
          \`\`\`
          EOF

          # Output for GitHub summary
          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create/Update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Database Snapshot
          body_path: release_notes.md
          files: |
            ${{ github.workspace }}/.cache/binance-futures/availability.duckdb
            ${{ github.workspace }}/.cache/binance-futures/availability.duckdb.gz
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================================
      # NOTIFY: Post summary to GitHub Actions summary
      # ============================================================================

      - name: Create GitHub Actions summary
        if: always()
        env:
          VALIDATION_STATUS: ${{ steps.validate.outputs.validation_passed == 'true' && 'Passed' || 'Failed' }}
          LATEST_DATE: ${{ steps.stats.outputs.latest_date }}
          TOTAL_RECORDS: ${{ steps.stats.outputs.total_records }}
          AVAILABILITY_PCT: ${{ steps.stats.outputs.availability_pct }}
          TRIGGER: ${{ github.event_name }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Database Update Summary

          ## Status
          - **Validation**: $VALIDATION_STATUS
          - **Latest Date**: $LATEST_DATE
          - **Total Records**: $TOTAL_RECORDS
          - **Availability**: $AVAILABILITY_PCT%

          ## Workflow Details
          - **Trigger**: $TRIGGER
          - **Run ID**: $RUN_ID
          - **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Next Steps
          - Database published to [latest release](https://github.com/$REPO/releases/tag/latest)
          - Download: \`wget https://github.com/$REPO/releases/download/latest/availability.duckdb.gz\`
          EOF

      # ============================================================================
      # CLEANUP: Remove temporary files
      # ============================================================================

      - name: Cleanup
        if: always()
        run: |
          rm -f stats.json release_notes.md awscliv2.zip
          rm -rf aws/
